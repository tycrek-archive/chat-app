<!doctype html>
<html>
	<head>
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
		<script src="bundle.js"></script>
		<script type="text/javascript">
			var login = () => {
				let username = document.getElementById('login-username').value;
				let password = document.getElementById('login-password').value;
				let encpass = btoa(password);
				fetch(`/user/login/${username}/${encpass}`)
				.then((res) => {
					return res.json();
				}).then((json) => {
					$('#login-result').html(JSON.stringify(json));
				});
			};

			var newUser = () => {
				let username = $('#newuser-username').val();
				let password = $('#newuser-password').val();
				let encpass = btoa(password);
				fetch(`/user/create/${username}/${encpass}`)
				.then((res) => res.json())
				.then((json) => {
					$('#newuser-result').html(JSON.stringify(json));
				});
			};

			var runQuery = () => {
				let query = btoa($('#query').val());
				let token = $('#token').val();
				fetch(`/query/${query}?token=${token}`)
				.then((res) => res.json())
				.then((json) => $('#query-result').html(JSON.stringify(json, null, 4)));
			};

			var sendMsg = function() {
				let token = $('#token').val();
				let toUser = $('#toUser').val();
				let message = btoa($('#sendMessage').val());

				fetch(`/keypairs/public/${toUser}?token=${token}`)
				.then((res) => res.json())
				.then((json) => {
					if (json.code != 200) throw 'Error';
					else return json.data.pubKey;
				})
				.then((pubKey) => encrypt(message, pubKey))
				.then((encrypted) => $('#send-result').html(encrypted))
				.catch((err) => alert(err));
			};

			var decryptMsg = function() {
				let token = $('#token').val();
				let encrypted = $('#decrypt-text').val();
				let password = $('#decrypt-pass').val();

				fetch(`/keypairs/private?token=${token}`)
				.then((res) => res.json())
				.then((json) => {
					if (json.code != 200) throw 'Error';
					else return json.data.privKey;
				})
				.then((privKey) => decrypt(encrypted, privKey, password))
				.then((decrypted) => $('#decrypt-result').html(decrypted))
				.catch((err) => (console.error(err), alert(err)));
			};
		</script>
	</head>
	<body>
		<h1>App tests</h1>
		Token: <input id="token" type="text">
		<hr>

		<h2>Run any query</h2>
		<form>
			<input id="query" type="text"><br>
			<input type="button" onclick="runQuery();" value="Run query">
		</form>
		<pre id="query-result">&nbsp;</pre>

		<hr>

		<h2>Create new user</h2>
		<form>
			Username: <input id="newuser-username" type="text"><br>
			Password: <input id="newuser-password" type="text"><br>
			<input type="button" onclick="newUser()" value="Create user">
		</form>
		<pre id="newuser-result">&nbsp;</pre>

		<hr>

		<h2>Login user</h2>
		<form>
			Username: <input id="login-username" type="text"><br>
			Password: <input id="login-password" type="text"><br>
			<input type="button" onclick="login()" value="Login">
		</form>
		<pre id="login-result">&nbsp;</pre>

		<hr>

		<h2>Send message</h2>
		<form>
			To: <input id="toUser" type="text"><br>
			Message: <input id="sendMessage" type="text"><br>
			<input type="button" onclick="sendMsg()" value="Send">
		</form>
		<pre id="send-result">&nbsp;</pre>

		<hr>

		<h2>Decrypt message</h2>
		<form>
			Encrypted: <input id="decrypt-text" type="text"><br>
			Password: <input id="decrypt-pass" type="text"><br>
			<input type="button" onclick="decryptMsg()" value="Decrypt">
		</form>
		<pre id="decrypt-result">&nbsp;</pre>
	</body>
</html>